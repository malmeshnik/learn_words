{% extends "base.html" %}

{% block title %}Слова кімнати{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/room_words.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
{% endblock %}

{% block content %}
    <!-- Спінер завантаження -->
    <div id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <!-- Модальне вікно для редагування слова -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Редагувати слово</h2>
                <span class="close-modal" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editWordForm" class="modal-form">
                <input type="hidden" id="editWordId">
                <div class="input-group">
                    <label for="editWordEn">Слово англійською</label>
                    <input type="text" id="editWordEn" placeholder="Введіть слово англійською">
                </div>
                <div class="input-group">
                    <label for="editWordRu">Слово російською</label>
                    <input type="text" id="editWordRu" placeholder="Введіть слово російською">
                </div>
                <button type="button" class="primary-btn" onclick="saveEditedWord()">
                    <i class="fas fa-save"></i> Зберегти
                </button>
            </form>
        </div>
    </div>

    <header class="page-header">
        <div class="container">
            <h1>
                <i class="fas fa-language"></i> 
                Слова для кімнати "{{ room.name }}"
            </h1>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-body">
                <div class="toggle-container">
                    <div class="mode-label">Режим відтворення:</div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="randomPlayback" {% if user_settings.random_playback %}checked{% endif %}>
                        <label for="randomPlayback"></label>
                        <span id="playbackModeText">
                            {% if user_settings.random_playback %}Випадковий порядок{% else %}Послідовний порядок{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card word-section">
            <div class="card-body">
                <form id="wordSelectionForm">
                    {% csrf_token %}
                    
                    <!-- Кнопки управління -->
                    <div class="word-controls">
                        <button type="button" onclick="addSelectedWords()" class="primary-btn">
                            <i class="fas fa-plus-circle"></i> Додати обрані до мого списку
                        </button>
                        <button type="button" onclick="toggleSelectAll()" class="secondary-btn">
                            <i class="fas fa-check-double"></i> <span id="selectAllText">Вибрати все</span>
                        </button>
                    </div>

                    <!-- Загальні слова кімнати -->
                    <div class="word-list-container">
                        <ul id="wordList" class="word-list">
                            {% for word in words %}
                                <li class="word-item">
                                    <label class="word-label">
                                        <div class="checkbox-wrapper">
                                            <input
                                                class="word-checkbox item-checkbox"
                                                type="checkbox"
                                                name="selected_words"
                                                value="{{ word.id }}"
                                                data-item-type="word"
                                                data-item-id="{{ word.id }}"
                                                {% if word.id in selected_word_ids %}checked{% endif %}
                                            >
                                            <span class="checkmark"></span>
                                        </div>
                                        <div class="word-content">
                                            <span class="word-en">{{ word.en }}</span>
                                            <span class="divider">-</span>
                                            <span class="word-ru">{{ word.ru }}</span>
                                        </div>
                                    </label>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Ваші слова в кімнаті -->
                    <div class="word-list-container">
                        <ul id="userWordList" class="word-list">
                            {% for word in user_words %}
                                <li class="word-item">
                                    <label class="word-label">
                                        <div class="checkbox-wrapper">
                                            <input
                                                class="word-checkbox item-checkbox"
                                                type="checkbox"
                                                name="selected_words"
                                                value="{{ word.id }}"
                                                data-item-type="word"
                                                data-item-id="{{ word.id }}"
                                                {% if word.id in selected_word_ids %}checked{% endif %}
                                            >
                                            <span class="checkmark"></span>
                                        </div>
                                        <div class="word-content">
                                            <span class="word-en" id="wordEn">{{ word.en }}</span>
                                            <span class="divider">-</span>
                                            <span class="word-ru" id="wordRu">{{ word.ru }}</span>
                                        </div>
                                    </label>
                                    <div class="word-actions">
                                        <button type="button" class="icon-btn edit-word" onclick="editWord('{{ word.id }}', '{{ word.en|escapejs }}', '{{ word.ru|escapejs }}')">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button type="button" class="icon-btn delete-word" onclick="deleteWord('{{ word.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </form>

                <!-- Повідомлення про успіх/помилку -->
                <div id="message" class="feedback-message"></div>
            </div>
        </div>

        <!-- Форма для додавання нового слова -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-plus"></i> Додати нове слово</h3>
            </div>
            <div class="card-body">
                <span>Введіть слово англійською або ж російською для додавання</span>
                <form id="addWordForm" class="add-word-form">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="input-group">
                            <label for="addWordEn">Слово англійською</label>
                            <input type="text" id="addWordEn" placeholder="Введіть слово англійською">
                        </div>
                        <div class="input-group">
                            <label for="addWordRu">Слово російською</label>
                            <input type="text" id="addWordRu" placeholder="Введіть слово російською">
                        </div>
                        <button type="button" class="primary-btn" onclick="submitNewWord()">
                            <i class="fas fa-plus"></i> Додати слово
                        </button>
                    </div>
                    <p id="wordErrorMessage" class="error-message"></p>
                </form>
            </div>
        </div>
    </main>

    <script>
        let allSelected = false;
        let isRandom = {% if user_settings.random_playback %}true{% else %}false{% endif %};

        function getCSRFToken() {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }
            console.warn('CSRF token input not found in room_words.html');
            return '';
        }
        
        // Функція для показу спінера перед переходом на іншу сторінку
        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.item-checkbox[data-item-type="word"]');
            allSelected = !allSelected; // Toggle the global state for button text

            checkboxes.forEach(checkbox => {
                const newCheckedState = !checkbox.checked; // Invert current state
                checkbox.checked = newCheckedState; // Apply new state

                // Call updateSelection for each checkbox with its new state
                const itemId = checkbox.dataset.itemId;
                const itemType = checkbox.dataset.itemType;
                if (itemId && itemType) {
                    updateSelection(itemId, itemType, newCheckedState);
                } else {
                    console.warn('Missing data-item-id or data-item-type on checkbox:', checkbox);
                }
            });
        
            const button = document.getElementById('selectAllText');
            // Button text is determined by the toggled allSelected flag
            button.textContent = allSelected ? "Скасувати вибір" : "Вибрати все";
        }        

        // Функція для приховування спінера після завантаження нової сторінки
        window.addEventListener('load', function() {
            document.getElementById('loadingSpinner').style.display = 'none';
        });

        function submitNewWord() {
            var roomId = "{{ room.id }}";
            var wordEn = document.getElementById('addWordEn').value;
            var wordRu = document.getElementById('addWordRu').value;
            var errorMessage = document.getElementById('wordErrorMessage');

                var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                showSpinner();

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/add_word/', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onload = function () {
                    var response = JSON.parse(xhr.responseText);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    
                    if (response.success) {
                        var wordList = document.getElementById('userWordList');
                        var newLi = document.createElement('li');
                        newLi.classList.add('word-item');
                        newLi.innerHTML = `
                            <label class="word-label">
                                <div class="checkbox-wrapper">
                                    <input class="word-checkbox" type="checkbox" name="selected_words" value="${response.id}">
                                    <span class="checkmark"></span>
                                </div>
                                <div class="word-content">
                                    <span class="word-en" id="wordEn">${response.en}</span>
                                    <span class="divider">-</span>
                                    <span class="word-ru" id="wordRu">${response.ru}</span>
                                </div>
                            </label>
                            <div class="word-actions">
                                <button type="button" class="icon-btn edit-word" onclick="editWord('${response.id}', '${response.en}')">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button type="button" class="icon-btn delete-word" onclick="deleteWord('${response.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        wordList.appendChild(newLi);

                        document.getElementById('addWordEn').value = '';
                        document.getElementById('addWordRu').value = '';
                        errorMessage.textContent = '';
                        
                        const messageEl = document.getElementById("message");
                        messageEl.textContent = "Слово успішно додано!";
                        messageEl.className = "feedback-message success";
                        setTimeout(() => {
                            messageEl.textContent = "";
                            messageEl.className = "feedback-message";
                        }, 3000);
                    } else {
                        errorMessage.textContent = response.error;
                    }
                };
                xhr.send('csrfmiddlewaretoken=' + encodeURIComponent(csrfToken) + 
                         '&room_id=' + encodeURIComponent(roomId) + 
                         '&room_name=' + encodeURIComponent("{{ room.name }}") +
                         '&en=' + encodeURIComponent(wordEn) + 
                         '&ru=' + encodeURIComponent(wordRu));
        }

        function editWord(wordId, wordEn, wordRu) {
            // Заповнюємо форму даними слова
            document.getElementById('editWordId').value = wordId;
            document.getElementById('editWordEn').value = wordEn;
            document.getElementById('editWordRu').value = wordRu;
            
            // Відкриваємо модальне вікно
            document.getElementById('editModal').style.display = 'block';
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            setTimeout(() => {
                document.getElementById('editModal').style.display = 'none';
            }, 300);
        }

        function saveEditedWord() {
            const wordId = document.getElementById('editWordId').value;
            const wordEn = document.getElementById('editWordEn').value;
            const wordRu = document.getElementById('editWordRu').value; // Read Russian word
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (wordEn.trim() === '') {
                alert('Будь ласка, заповніть поле англійського слова!'); // More specific alert
                return;
            }
            
            showSpinner();
            
            fetch("{% url 'edit_word' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    wordId: wordId,
                    en: wordEn,
                    ru: wordRu // Include Russian word in payload
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Оновлюємо відображення слова на сторінці
                    const wordItems = document.querySelectorAll('.word-item');
                    for (let item of wordItems) {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        if (checkbox && checkbox.value == wordId) {
                            const wordEnText = item.querySelector('.word-en');
                            const wordRuText = item.querySelector('.word-ru');
                            wordEnText.textContent = data.word.en;
                            wordRuText.textContent = data.word.ru;
                            break;
                        }
                    }
                    
                    const messageEl = document.getElementById("message");
                    messageEl.textContent = "Слово успішно оновлено!";
                    messageEl.className = "feedback-message success";
                    setTimeout(() => {
                        messageEl.textContent = "";
                        messageEl.className = "feedback-message";
                    }, 3000);
                    
                    closeEditModal();
                } else {
                    const messageEl = document.getElementById("message");
                    messageEl.textContent = "Помилка при оновленні слова.";
                    messageEl.className = "feedback-message error";
                }
                document.getElementById('loadingSpinner').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                const messageEl = document.getElementById("message");
                messageEl.textContent = "Помилка при оновленні слова.";
                messageEl.className = "feedback-message error";
                document.getElementById('loadingSpinner').style.display = 'none';
            });
        }

        function deleteWord(wordId) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (confirm('Ви дійсно бажаєте видалити це слово?')) {
                showSpinner();
                
                fetch("{% url 'delete_room_word' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({wordId: wordId})
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const messageEl = document.getElementById("message");
                        messageEl.textContent = "Слово видалено з вашого списку!";
                        messageEl.className = "feedback-message success";
                        
                        // Видаляємо елемент з DOM з анімацією
                        const wordItems = document.querySelectorAll('.word-item');
                        for (let item of wordItems) {
                            const checkbox = item.querySelector('input[type="checkbox"]');
                            if (checkbox && checkbox.value == wordId) {
                                item.style.opacity = '0';
                                item.style.transform = 'translateX(20px)';
                                setTimeout(() => {
                                    item.remove();
                                }, 300);
                                break;
                            }
                        }
                        
                        setTimeout(() => {
                            messageEl.textContent = "";
                            messageEl.className = "feedback-message";
                        }, 3000);
                    } else {
                        const messageEl = document.getElementById("message");
                        messageEl.textContent = "Помилка при видаленні.";
                        messageEl.className = "feedback-message error";
                    }
                    document.getElementById('loadingSpinner').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    const messageEl = document.getElementById("message");
                    messageEl.textContent = "Помилка при видаленні.";
                    messageEl.className = "feedback-message error";
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
            }
        }

        function addSelectedWords() {
            const checkboxes = document.querySelectorAll('.item-checkbox[data-item-type="word"]');
            let selectedWordsForSession = []; // For existing session logic
            let wordsSelectedForDBUpdate = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const itemId = checkbox.dataset.itemId;
                    const itemType = checkbox.dataset.itemType;

                    // New logic: Call updateSelection for each selected word to update DB
                    if (itemId && itemType) {
                        updateSelection(itemId, itemType, true); // true because it's checked
                        wordsSelectedForDBUpdate++;
                    }

                    // Existing logic: Collect IDs for session-based learning
                    selectedWordsForSession.push(itemId);
                }
            });
                
            if (wordsSelectedForDBUpdate === 0) { // Check if any words were selected for DB update
                const messageEl = document.getElementById("message");
                messageEl.textContent = "Будь ласка, виберіть слова для додавання.";
                messageEl.className = "feedback-message error";
                setTimeout(() => {
                    messageEl.textContent = "";
                    messageEl.className = "feedback-message";
                }, 3000);
                return;
            }
            
            // Display a message based on DB update
            const messageEl = document.getElementById("message");
            messageEl.textContent = `Вибрані слова (${wordsSelectedForDBUpdate}) оновлено у вашому списку.`;
            messageEl.className = "feedback-message success";
            setTimeout(() => {
                messageEl.textContent = "";
                messageEl.className = "feedback-message";
            }, 3000); // Message will disappear after 3 seconds

            // Existing logic for session-based word learning (if still needed)
            // This part can be reviewed or removed if updateSelection covers all needs
            if (selectedWordsForSession.length > 0) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                // showSpinner(); // Spinner might be shown by updateSelection or here if needed

                fetch("{% url 'add_selected_words' %}", { // This URL might be for session logic
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        word_ids: selectedWordsForSession,
                        is_random: isRandom // Assuming isRandom is defined globally
                    }),
                })
                .then(res => res.json())
                .then(data => {
                    // hideSpinner(); // Hide spinner if shown
                    if (data.success) {
                        console.log("Session words processed successfully.");
                        // Removed: window.location.href = "/categories/";
                        // The page will not redirect, allowing users to see messages.
                    } else {
                        console.error("Error processing session words:", data.error);
                        // Optionally, display a different message for session processing errors
                    }
                })
                .catch(error => {
                    // hideSpinner(); // Hide spinner if shown
                    console.error('Error processing session words:', error);
                });
            }
        }

        document.getElementById('randomPlayback').addEventListener('change', function() {
            isRandom = this.checked;
            const modeText = document.getElementById('playbackModeText');
            modeText.textContent = isRandom ? 'Випадковий порядок' : 'Послідовний порядок';
            
            // Анімація зміни тексту
            modeText.style.opacity = '0';
            setTimeout(() => {
                modeText.style.opacity = '1';
            }, 200);
        });

        // Закривання модального вікна при кліку поза ним
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }

        // Додаткові анімації для покращення взаємодії
        document.querySelectorAll('.word-item').forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        function handleDeleteSelectedWords() {
            const selectedWordIds = Array.from(document.querySelectorAll('.item-checkbox[data-item-type="word"]:checked'))
                                       .map(cb => cb.dataset.itemId);

            if (selectedWordIds.length === 0) {
                const messageEl = document.getElementById("message");
                messageEl.textContent = "Please select words to delete.";
                messageEl.className = "feedback-message error";
                setTimeout(() => {
                    messageEl.textContent = "";
                    messageEl.className = "feedback-message";
                }, 3000);
                return;
            }

            if (!confirm('Are you sure you want to delete the selected words? This action will only delete words you own.')) {
                return;
            }

            const csrfToken = getCSRFToken();
            showSpinner();

            fetch("/delete_selected_words/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ word_ids: selectedWordIds }),
            })
            .then(response => response.json())
            .then(data => {
                hideSpinner();
                if (data.success) {
                    const messageEl = document.getElementById("message");
                    messageEl.textContent = `Successfully deleted ${data.deleted_count} words.`;
                    messageEl.className = "feedback-message success";
                    setTimeout(() => {
                        messageEl.textContent = "";
                        messageEl.className = "feedback-message";
                    }, 3000);

                    // Remove deleted words from the DOM
                    selectedWordIds.forEach(wordId => {
                        const checkbox = document.querySelector(`.item-checkbox[data-item-id="${wordId}"]`);
                        if (checkbox) {
                            const wordItem = checkbox.closest('.word-item');
                            if (wordItem) {
                                wordItem.style.opacity = '0';
                                wordItem.style.transform = 'translateX(20px)';
                                setTimeout(() => {
                                    wordItem.remove();
                                }, 300);
                            }
                        }
                    });
                } else {
                    const messageEl = document.getElementById("message");
                    messageEl.textContent = "Error deleting words: " + (data.error || "Unknown error");
                    messageEl.className = "feedback-message error";
                     setTimeout(() => {
                        messageEl.textContent = "";
                        messageEl.className = "feedback-message";
                    }, 5000);
                }
            })
            .catch(error => {
                hideSpinner();
                console.error('Error deleting selected words:', error);
                const messageEl = document.getElementById("message");
                messageEl.textContent = "Error deleting words. See console for details.";
                messageEl.className = "feedback-message error";
                setTimeout(() => {
                    messageEl.textContent = "";
                    messageEl.className = "feedback-message";
                }, 5000);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Other listeners if any...
            const deleteBtn = document.getElementById('deleteSelectedWordsBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleDeleteSelectedWords);
            }
        });

        // Function to hide spinner (if not already globally available and used by other functions here)
        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    </script>
{% endblock %}