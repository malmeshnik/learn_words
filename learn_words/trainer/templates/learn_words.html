<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–≤—á–µ–Ω–Ω—è —Å–ª—ñ–≤</title>
    <link rel="stylesheet" href="/static/css/learn_words.css">
</head>
<body>
    <h2>–í–∏–≤—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–∏—Ö —Å–ª—ñ–≤</h2>

    <div class="control-inputs" id="settingsBlock">
        {% csrf_token %}
        <div>
            <label for="repeatCount">üîÅ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å —É—Ä–æ–∫—É:</label><br>
            <input type="number" id="lessonRepeatCount" value="{{ user_settings.lesson_repeat_count }}" min="1">
        </div>
        <div>
            <label for="repeatCount">üîÅ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞:</label><br>
            <input type="number" id="repeatCount" value="{{ user_settings.repeat_count }}" min="1">
        </div>
        <div>
            <label for="pauseBetween">‚è∏Ô∏è –ü–∞—É–∑–∞ –º—ñ–∂ —Å–ª–æ–≤–∞–º–∏ (—Å):</label><br>
            <input type="number" id="pauseBetween" value="{{ user_settings.pause_between }}" min="0">
        </div>
        <div>
            <label for="delayBeforeTranslation">‚è≥ –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª–∞–¥–æ–º (—Å):</label><br>
            <input type="number" id="delayBeforeTranslation" value="{{ user_settings.delay_before_translation }}" min="0.5">
        </div>
        <div>
            <label for="playbackSpeed">üéöÔ∏è –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–∑–≤—É—á—É–≤–∞–Ω–Ω—è:</label><br>
            <input type="number" id="playbackSpeed" value="{{ user_settings.playback_speed|default:1 }}" min="0.5" max="2" step="0.1">
        </div>
        <div>
            <label for="playbackSpeed">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ—á–µ–Ω—å —è–∫—É –≤–∏–≤–æ–¥–∏—Ç–∏</label><br>
            <input type="number" id="sentenceValue" value="15" min="1" max="100000" step="5">
        </div>
        <div>
            <label>
                <input type="checkbox" id="hideTranslation" value="{{ user_settings.hide_translation }}">
                ‚ùå –ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥
            </label>
            <div>
                <label>
                    <input type="checkbox" id="enableWordAudio">
                    üîä –û–∑–≤—É—á—É–≤–∞—Ç–∏ —Å–ª–æ–≤–∞
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="enableSentenceAudio" checked>
                    üîä –û–∑–≤—É—á—É–≤–∞—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="playTranslationFirst">
                    üîÑ –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥
                </label>
            </div>
        </div>
    </div>

    <button id="startBtn">–ü–æ—á–∞—Ç–∏</button>

    <div id="wordsList">
        <!-- –î–æ–¥–∞–º–æ —Å–ø–∏—Å–æ–∫ —Å–ª—ñ–≤ —Ç—É—Ç -->
    </div>

    <div class="word-box" id="wordBox">
        
    </div>

    <div class="translation" id="translationBox"></div>

    <div class="sentence-controls" id="sentenceControls">
        <button id="backSentenceButton">‚è™ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è</button>
        <button id="BackWordButton">‚è™ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Å–ª–æ–≤–æ</button>
        <button id="showTranslation">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥</button>
        <button id="pauseBtnLabel" onclick="togglePause()"><span>‚è∏Ô∏è –ü–∞—É–∑–∞</span></button>
    </div>

    <div class="result-buttons" id="mainMenuButton">
        <button onclick="goToMainMenu()">–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>
    </div> 
    <div class="result-buttons" id="restartButton" style="display: none;">
        <button onclick="restartLearning()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div> 

    <h3>–ü–æ–∑–Ω–∞—á—Ç–µ —Å–ª–æ–≤–æ —è–∫–µ –≤–∂–µ –≤–∏–≤—á–∏–ª–∏</h3>
    <div class="words-container" id="wordsContainer"></div>

    <audio id="audioPlayer"></audio>

    <script>
        let isPaused = false;
        let currentIndex = 0; // –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –ø–æ —Ä–µ—á–µ–Ω–Ω—è—Ö
        let currentSentences = []; // –º–∞—Å–∏–≤ —Ä–µ—á–µ–Ω—å –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å–ª–æ–≤–∞
        let timer;
        const pauseAfterSentence = 3000;
        let autoSwitch = true;
        let isPlaying = false;
        let isContinuingPlayback = false;
        let stopCurrentTranslation = false;

        const words = {{ words|safe }};
        let sentences = {{ sentences|safe }};
        let index = 0;
        const audioPlayer = document.getElementById('audioPlayer');

        async function waitWhilePaused(timer = 200) {
            while (isPaused) {
                await sleep(timer);
            }
        }

        async function pauseForTranslation(duration = 5000, checkInterval = 200) {
            let elapsed = 0;
            while (elapsed < duration) {
                if (stopCurrentTranslation) {
                    break; // –ï—Å–ª–∏ –ø–∞—É–∑–∞ —Å–Ω—è—Ç–∞ ‚Äî –≤—ã—Ö–æ–¥–∏–º
                }
                await sleep(checkInterval);
                elapsed += checkInterval;
            }
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById("pauseBtnLabel").textContent = isPaused ? '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
            
            if (isPaused) {
                // –ï—Å–ª–∏ –Ω–∞ –ø–∞—É–∑–µ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ
                stopCurrentAudio();
            } else {
                // –Ø–∫—â–æ –≤–∏—Ö–æ–¥–∏–º–æ –∑ –ø–∞—É–∑–∏ ‚Äî –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –∞—É–¥—ñ–æ
                if (audioPlayer.src && audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.warn("Resume play error:", e));
                }
            }
        }
                
        // –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Å–ª–æ–≤–æ–º
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
                
        async function playAudio(src, speed = 1.0) {
            // –û—Å—Ç–∞–Ω–æ–≤–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –≤—Å–µ –µ—â–µ –∏–¥–µ—Ç
            // stopCurrentAudio();
            
            return new Promise((resolve) => {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                setTimeout(() => {
                    audioPlayer.src = src;
                    audioPlayer.playbackRate = speed;
                    
                    isPlaying = true;
                    
                    audioPlayer.play().then(() => {
                        audioPlayer.onended = () => {
                            isPlaying = false;
                            resolve();
                        };
                    }).catch((err) => {
                        console.warn("Audio play error:", err);
                        isPlaying = false;
                        resolve(); // –Ω–µ –∑–∞–≤–∏—Å–∞–µ–º
                    });
                }, 100);
            });
        }        

        function stopCurrentAudio() {
            audioPlayer.pause();
        }
            
        async function playCurrentWord() {
            const enableWordAudio = document.getElementById('enableWordAudio').checked;
            const playTranslationFirst = document.getElementById('playTranslationFirst').checked;

            const settings = getDelaySettings();
            const hideTranslation = document.getElementById('hideTranslation').checked;
            
            waitWhilePaused();

            if (index < 0) index = 0;
            if (index >= words.length) index = words.length - 1;

            const word = words[index];

            document.getElementById('wordBox').textContent = word.en;
            document.getElementById('translationBox').textContent = "";

            if (playTranslationFirst && !hideTranslation) {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–µ—Ä–µ–≤–æ–¥
                document.getElementById('wordBox').textContent = word.ru;
                document.getElementById('translationBox').textContent = "";
                
                if (enableWordAudio) {
                    await playAudio(`/media/audio/ru/${word.id}.mp3`);
                }
                
                await pauseForTranslation(settings.pauseBetween, 50);
                await waitWhilePaused();
                
                // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                document.getElementById('wordBox').textContent = word.en;
                
                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableWordAudio) {
                        await playAudio(`/media/audio/en/${word.id}.mp3`, settings.playbackSpeed);
                    }
                    
                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }
            } else {
                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–≤–æ–¥
                document.getElementById('wordBox').textContent = word.en;
                document.getElementById('translationBox').textContent = "";

                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableWordAudio) {
                        await playAudio(`/media/audio/en/${word.id}.mp3`, settings.playbackSpeed);
                    }

                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }


            await waitWhilePaused();
            await pauseForTranslation(settings.delayBeforeTranslation, 50);

            if (!hideTranslation) {
                if (enableWordAudio) {
                    await playAudio(`/media/audio/ru/${word.id}.mp3`);
                }
                document.getElementById('translationBox').textContent = word.ru;
            }
        }
            waitWhilePaused();

            await sleep(settings.pauseBetween);

            const wordElement = document.createElement('div');
            const wordText = document.createElement('span');
            const checkbox = document.createElement('input');

            wordElement.classList.add('word-item');
            wordText.classList.add('word-text');
            checkbox.classList.add('word-checkbox');

            wordText.textContent = `${word.en} - ${word.ru}`;
            checkbox.type = 'checkbox';
            checkbox.addEventListener('change', () => {
                wordElement.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
            });

            wordElement.appendChild(checkbox);
            wordElement.appendChild(wordText);
            document.getElementById('wordsContainer').appendChild(wordElement);
        }    
        
        async function playCurrentSentence() {
            const settings = getDelaySettings();
            const hideTranslation = document.getElementById('hideTranslation').checked;
            const enableSentenceAudio = document.getElementById('enableSentenceAudio').checked;
            const playTranslationFirst = document.getElementById('playTranslationFirst').checked;
            
            await waitWhilePaused();
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –º–µ–∂—ñ —ñ–Ω–¥–µ–∫—Å—É
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= sentences.length) currentIndex = sentences.length - 1;
            
            const sentence = sentences[currentIndex];
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∞–Ω–≥–ª—ñ–π—Å—å–∫–µ —Ä–µ—á–µ–Ω–Ω—è
            document.getElementById('wordBox').textContent = sentence.template;
            document.getElementById('translationBox').textContent = "";
            
            if (playTranslationFirst && !hideTranslation) {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–µ—Ä–µ–≤–æ–¥
                document.getElementById('wordBox').textContent = sentence.translate;
                document.getElementById('translationBox').textContent = "";
                
                if (enableSentenceAudio) {
                    await playAudio(`/${sentence.path_to_ru}`);
                }
                
                await pauseForTranslation(settings.pauseBetween, 50);
                await waitWhilePaused();
                
                // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                document.getElementById('wordBox').textContent = sentence.template;
                
                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableSentenceAudio) {
                        await playAudio(`/${sentence.path_to_en}`, settings.playbackSpeed);
                    }
                    
                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }
            } else {
                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–≤–æ–¥
                // –ü–æ–∫–∞–∑—É—î–º–æ –∞–Ω–≥–ª—ñ–π—Å—å–∫–µ —Ä–µ—á–µ–Ω–Ω—è
                document.getElementById('wordBox').textContent = sentence.template;
                document.getElementById('translationBox').textContent = "";
                
                // –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –∞—É–¥—ñ–æ —Ä–µ—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é
                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableSentenceAudio) {
                        await playAudio(`/${sentence.path_to_en}`, settings.playbackSpeed);
                    }
    
                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }
                
                // –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª–∞–¥–æ–º
                await waitWhilePaused();
                await pauseForTranslation(settings.delayBeforeTranslation, 50);
                
                // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–∞ –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –ø–µ—Ä–µ–∫–ª–∞–¥
                if (!hideTranslation) {
                    document.getElementById('translationBox').textContent = sentence.translate;
                    
                    if (enableSentenceAudio) {
                        await playAudio(`/${sentence.path_to_ru}`);
                    }
                }
            }
            
            waitWhilePaused();
            // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Ä–µ—á–µ–Ω–Ω—è–º/—Å–ª–æ–≤–æ–º
            await sleep(settings.pauseBetween);
        }

        document.getElementById('BackWordButton').addEventListener('click', async () => {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –∑–≤—É–∫
            stopCurrentAudio();
            stopCurrentTranslation = true;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω—É–∂–Ω–æ –µ–≥–æ –ø—Ä–µ—Ä–≤–∞—Ç—å
            if (isContinuingPlayback) {
                isContinuingPlayback = false;
                // –î–∞–µ–º –≤—Ä–µ–º—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                await sleep(200);
            }
            
            console.log(index)
            if (index < 0) index = 0;
            console.log(index)
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞
            playingWords();
        });
        
        document.getElementById('backSentenceButton').addEventListener('click', async () => {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –∑–≤—É–∫
            stopCurrentAudio();
            stopCurrentTranslation = true;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω—É–∂–Ω–æ –µ–≥–æ –ø—Ä–µ—Ä–≤–∞—Ç—å
            if (isContinuingPlayback) {
                isContinuingPlayback = false;
                // –î–∞–µ–º –≤—Ä–µ–º—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                await sleep(200);
            }
            
            console.log(currentIndex)
            if (currentIndex < 0) currentIndex = 0;
            console.log(currentIndex)
            
            // –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            PlayingSentences();
        });

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        async function PlayingSentences() {

            if (isContinuingPlayback) return;
            
            isContinuingPlayback = true;
            
            while (isContinuingPlayback && currentIndex < sentences.length) {
                await waitWhilePaused();
                stopCurrentTranslation = false;
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º—ñ—Å—Ç—å updateSentence
                await playCurrentSentence();
                
                // –ó–±—ñ–ª—å—à—É—î–º–æ —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                currentIndex++;
                
                // –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –±—É–≤ –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ü–∏–∫–ª—É
                if (!isContinuingPlayback) break;
            }
            
            if (isContinuingPlayback) {
                // –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ –¥–æ –∫—ñ–Ω—Ü—è –ø—Ä–∏—Ä–æ–¥–Ω–∏–º —à–ª—è—Ö–æ–º
                document.getElementById('wordBox').textContent = "–ì–æ—Ç–æ–≤–æ! üéâ";
                document.getElementById('translationBox').textContent = "";
                document.getElementById('restartButton').style.display = 'block';
                document.getElementById('mainMenuButton').style.display = 'block';
            }
            
            isContinuingPlayback = false;
        }
        
        
        async function playingWords() {

            if (isContinuingPlayback) return;

            isContinuingPlayback = true;
            

            while (isContinuingPlayback && index < words.length) {
                await waitWhilePaused();
                stopCurrentTranslation = false;

                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º—ñ—Å—Ç—å updateWord
                await playCurrentWord();

                // –ó–±—ñ–ª—å—à—É—î–º–æ —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                index++;

                // –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –±—É–≤ –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ü–∏–∫–ª—É
                if (!isContinuingPlayback) break;
            }

            isContinuingPlayback = false;

            if (index == words.length) {
                PlayingSentences();
            }
        }
 
        async function saveUserSettings() {
            const settings = getDelaySettings();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
            fetch("{% url 'save_user_settings' %}", {  // –≤–∏–ø—Ä–∞–≤–∏–≤ —Ç—É—Ç
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ user_settings: settings }),
            })
            .then(res => res.json())  // –¥–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó
            .then(data => {
                console.log('Settings saved:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }        
                
            
        async function startLearning() {
            const enableSentenceAudio = document.getElementById('enableSentenceAudio').checked;
            const enableWordAudio = document.getElementById('enableWordAudio').checked;
            const settings = getDelaySettings();

            console.log('lessonRepeatCount:', settings.lessonRepeatCount);

            currentIndex = 0;
            index = 0;

            saveSettingsToSession();
            saveUserSettings();
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('settingsBlock').style.display = 'none';
            document.getElementById('sentenceControls').style.display = 'block';
            document.getElementById('pauseBtnLabel').style.display = 'inline-flex';
            document.getElementById('showTranslation').style.display = 'inline-flex';

            for (let i = 0; i < settings.lessonRepeatCount; i++) {
                console.log(`=== –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ‚Ññ${i + 1} ===`);
                currentIndex = 0;
                index = 0;

                if (enableWordAudio) {
                    document.getElementById("backSentenceButton").style.display = 'none';
                    document.getElementById('BackWordButton').style.display = 'inline-flex';

                    await playingWords();
                }

                const sentenceValue = parseInt(document.getElementById('sentenceValue').value) || 15;
                
                if (sentenceValue > sentences.length) {
                    sentences = sentences.slice(0, sentenceValue);
                }
                
                if (enableSentenceAudio) {
                    document.getElementById("BackWordButton").style.display = 'none';
                    document.getElementById("backSentenceButton").style.display = 'inline-flex';

                    await PlayingSentences();
                }
            }
            
            
            document.getElementById('wordBox').textContent = "–ì–æ—Ç–æ–≤–æ! üéâ";
            document.getElementById('translationBox').textContent = "";
            document.getElementById('restartButton').style.display = 'block';
            document.getElementById('mainMenuButton').style.display = 'block';
        }

        function getDelaySettings() {
            return {
                repetitions: parseInt(document.getElementById('repeatCount').value) || 1,
                pauseBetween: parseFloat(document.getElementById('pauseBetween').value) * 1000 || 1000,
                delayBeforeTranslation: parseFloat(document.getElementById('delayBeforeTranslation').value) * 1000 || 1000,
                playbackSpeed: parseFloat(document.getElementById('playbackSpeed').value) || 1,
                lessonRepeatCount: parseInt(document.getElementById('lessonRepeatCount').value) || 1,
            };
        }

        function saveSettingsToSession() {
            const settings = {
                repetitions: parseInt(document.getElementById('repeatCount').value),
                pauseBetween: parseFloat(document.getElementById('pauseBetween').value),
                delayBeforeTranslation: parseFloat(document.getElementById('delayBeforeTranslation').value),
                playbackSpeed: parseFloat(document.getElementById('playbackSpeed').value),
                lessonRepeatCount: parseInt(document.getElementById('lessonRepeatCount').value)
            };
            sessionStorage.setItem('wordSettings', JSON.stringify(settings));
        }
            
        function restartLearning() {
            index = 0;
            currentIndex = 0;

            document.getElementById('restartButton').style.display = 'none';
            document.getElementById('mainMenuButton').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('settingsBlock').style.display = 'block';
            document.getElementById('wordBox').textContent = '';
            document.getElementById('translationBox').textContent = '';
            document.getElementById('wordsContainer').innerHTML = '';
        }
            
        function goToMainMenu() {
            window.location.href = '/';
        }

        document.getElementById("startBtn").addEventListener("click", startLearning);
        document.getElementById("showTranslation").addEventListener("click", function() {
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ
            stopCurrentAudio();
            
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–≤–æ–¥–æ–º
            stopCurrentTranslation = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–π—á–∞—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Å–ª–æ–≤–æ
            if (document.getElementById('enableSentenceAudio').checked && index < words.length) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                const word = words[index - 1 >= 0 ? index - 1 : 0];
                document.getElementById('translationBox').textContent = word.ru;
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ä—É—Å—Å–∫–∏–π –∞—É–¥–∏–æ –ø–µ—Ä–µ–≤–æ–¥, –µ—Å–ª–∏ –∞—É–¥–∏–æ –¥–ª—è —Å–ª–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ
                playAudio(`/media/audio/ru/${word.id}.mp3`);

                playingWords();
            } 
            else if (document.getElementById('enableWordAudio').checked && currentIndex < sentences.length) {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤

                const sentence = sentences[currentIndex - 1 >= 0 ? currentIndex - 1 : 0];
                document.getElementById('translationBox').textContent = sentence.translate;
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ä—É—Å—Å–∫–∏–π –∞—É–¥–∏–æ –ø–µ—Ä–µ–≤–æ–¥, –µ—Å–ª–∏ –∞—É–¥–∏–æ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤–∫–ª—é—á–µ–Ω–æ
                playAudio(`/${sentence.path_to_ru}`);

                PlayingSentences();
            }
        
            
            // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º playingWords() —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –ø–µ—Ä–µ–≤–æ–¥–∞, 
            // —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        });
        
        
    </script>
</body>
</html>
