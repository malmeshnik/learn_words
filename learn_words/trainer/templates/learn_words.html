<!DOCTYPE html>
<html lang="uk" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–≤—á–µ–Ω–Ω—è —Å–ª—ñ–≤</title>
    <style>
    :root {
        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ - –æ—Å–Ω–æ–≤–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ */
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-elevated: #252525;
        --text-primary: #e4e6eb;
        --text-secondary: #b0b3b8;
        --text-muted: #777;
        --border-color: #333;
        --accent-primary: #4f8aff;
        --accent-secondary: #3a6fc7;
        --success-color: #4caf50;
        --error-color: #e53935;
        --warning-color: #ff9800;
        --card-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        
        /* –†–æ–∑–º—ñ—Ä–∏ */
        --border-radius-sm: 6px;
        --border-radius-md: 10px;
        --border-radius-lg: 15px;
        --spacing-xs: 5px;
        --spacing-sm: 10px;
        --spacing-md: 15px;
        --spacing-lg: 20px;
        --spacing-xl: 30px;
        
        /* –®—Ä–∏—Ñ—Ç */
        --font-size-xs: 12px;
        --font-size-sm: 14px;
        --font-size-md: 16px;
        --font-size-lg: 18px;
        --font-size-xl: 24px;
        --font-size-xxl: 32px;
        --font-size-xxxl: 40px;
    }

    /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 0 var(--spacing-lg);
    }

    .container {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        padding: var(--spacing-lg) 0;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
    h1, h2, h3, h4 {
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    h2 {
        font-size: var(--font-size-xl);
        text-align: center;
        margin-bottom: var(--spacing-lg);
    }

    h3 {
        font-size: var(--font-size-lg);
        margin-top: var(--spacing-lg);
    }

    /* –ö–∞—Ä—Ç–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
    .card {
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius-md);
        box-shadow: var(--card-shadow);
        margin-bottom: var(--spacing-xl);
        overflow: hidden;
    }

    .card-header {
        background-color: var(--bg-elevated);
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
    }

    .card-body {
        padding: var(--spacing-lg);
    }

    /* –§–æ—Ä–º–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
    .control-inputs {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .control-inputs > div {
        margin-bottom: var(--spacing-md);
    }

    .control-inputs label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }

    .control-inputs input[type="number"],
    .control-inputs input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        color: var(--text-primary);
        font-size: var(--font-size-md);
        transition: border-color 0.2s;
    }

    .control-inputs input:focus {
        border-color: var(--accent-primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 138, 255, 0.15);
    }

    /* –ß–µ–∫–±–æ–∫—Å–∏ */
    .control-inputs input[type="checkbox"] {
        margin-right: var(--spacing-xs);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
        cursor: pointer;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        border: none;
        border-radius: var(--border-radius-lg);
        font-size: var(--font-size-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none;
        min-height: 48px;
    }

    button:hover {
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(1px);
    }

    #startBtn {
        background-color: var(--accent-primary);
        color: white;
        font-weight: 600;
        margin: 0 auto;
        display: block;
        min-width: 180px;
        margin-bottom: var(--spacing-xl);
    }

    #startBtn:hover {
        background-color: var(--accent-secondary);
    }

    /* –°–ª–æ–≤–æ —Ç–∞ –ø–µ—Ä–µ–∫–ª–∞–¥ */
    .word-box {
        font-size: var(--font-size-xxxl);
        text-align: center;
        padding: var(--spacing-xl) 0;
        margin: var(--spacing-md) 0;
        color: var(--text-primary);
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .translation {
        font-size: var(--font-size-xxl);
        text-align: center;
        color: var(--accent-primary);
        margin-bottom: var(--spacing-xl);
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ—á–µ–Ω–Ω—è–º–∏ */
    .sentence-controls {
        display: none;
        justify-content: center;
        gap: var(--spacing-md);
        flex-wrap: wrap;
        margin-bottom: var(--spacing-xl);
    }

    .sentence-controls button {
        background-color: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        padding: 8px 16px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-sm);
    }

    .sentence-controls button:hover {
        background-color: rgba(255, 255, 255, 0.12);
    }

    /* –°–ø–∏—Å–æ–∫ –≤–∏–≤—á–µ–Ω–∏—Ö —Å–ª—ñ–≤ */
    .words-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .word-item {
        display: flex;
        align-items: center;
        padding: var(--spacing-md);
        border-radius: var(--border-radius-sm);
        background-color: var(--bg-elevated);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
    }

    .word-item:hover {
        background-color: #2a2a2a;
        transform: translateY(-2px);
    }

    .word-checkbox {
        margin-right: var(--spacing-md);
    }

    .word-text {
        color: var(--text-secondary);
    }

    /* –ö–Ω–æ–ø–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É */
    .result-buttons {
        display: flex;
        justify-content: center;
        margin: var(--spacing-xl) 0;
    }

    .result-buttons button {
        background-color: var(--bg-elevated);
        color: var(--text-primary);
        margin: 0 var(--spacing-sm);
    }

    .result-buttons button:hover {
        background-color: var(--bg-secondary);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
    @media screen and (max-width: 768px) {
        .control-inputs {
            grid-template-columns: 1fr;
        }

        .sentence-controls {
            flex-direction: column;
        }

        .sentence-controls button {
            width: 100%;
            margin-bottom: var(--spacing-sm);
        }
    }

    @media screen and (max-width: 480px) {
        body {
            padding: 0 var(--spacing-sm);
        }

        h2 {
            font-size: var(--font-size-lg);
        }

        .word-box {
            font-size: var(--font-size-xl);
        }

        .translation {
            font-size: var(--font-size-lg);
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <h2>–í–∏–≤—á–µ–Ω–Ω—è –∞–Ω–≥–ª—ñ–π—Å—å–∫–∏—Ö —Å–ª—ñ–≤</h2>

        <div class="card" id="settingsBlock">
            <div class="card-header">
                <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
            </div>
            <div class="card-body">
                <div class="control-inputs">
                    {% csrf_token %}
                    <div>
                        <label for="lessonRepeatCount">üîÅ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å —É—Ä–æ–∫—É:</label>
                        <input type="number" id="lessonRepeatCount" value="{{ user_settings.lesson_repeat_count }}" min="1">
                    </div>
                    <div>
                        <label for="repeatCount">üîÅ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å –∫–æ–∂–Ω–æ–≥–æ —Å–ª–æ–≤–∞:</label>
                        <input type="number" id="repeatCount" value="{{ user_settings.repeat_count }}" min="1">
                    </div>
                    <div>
                        <label for="pauseBetween">‚è∏Ô∏è –ü–∞—É–∑–∞ –º—ñ–∂ —Å–ª–æ–≤–∞–º–∏ (—Å):</label>
                        <input type="number" id="pauseBetween" value="{{ user_settings.pause_between }}" min="0">
                    </div>
                    <div>
                        <label for="delayBeforeTranslation">‚è≥ –î–æ–¥–∞—Ç–∏ —á–∞—Å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª–∞–¥–æ–º (—Å):</label>
                        <input type="number" id="delayBeforeTranslation" value="{{ user_settings.delay_before_translation }}" min="0.5">
                    </div>
                    <div>
                        <label for="playbackSpeed">üéöÔ∏è –®–≤–∏–¥–∫—ñ—Å—Ç—å –æ–∑–≤—É—á—É–≤–∞–Ω–Ω—è:</label>
                        <input type="number" id="playbackSpeed" value="{{ user_settings.playback_speed|default:1 }}" min="0.5" max="2" step="0.1">
                    </div>
                    <div>
                        <label for="sentenceValue">üìã –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ—á–µ–Ω—å:</label>
                        <input type="number" id="sentenceValue" value="15" min="1" max="100000" step="5">
                    </div>
                    <div>
                        <div class="checkbox-label">
                            <input type="checkbox" id="hideTranslation" value="{{ user_settings.hide_translation }}">
                            <span>‚ùå –ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥</span>
                        </div>
                        <div class="checkbox-label">
                            <input type="checkbox" id="enableWordAudio" checked>
                            <span>üîä –û–∑–≤—É—á—É–≤–∞—Ç–∏ —Å–ª–æ–≤–∞</span>
                        </div>
                        <div class="checkbox-label">
                            <input type="checkbox" id="enableSentenceAudio" checked>
                            <span>üîä –û–∑–≤—É—á—É–≤–∞—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è</span>
                        </div>
                        <div class="checkbox-label">
                            <input type="checkbox" id="playTranslationFirst">
                            <span>üîÑ –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button id="startBtn">–ü–æ—á–∞—Ç–∏ –≤–∏–≤—á–µ–Ω–Ω—è</button>

        <div class="word-box" id="wordBox"></div>
        <div class="translation" id="translationBox"></div>

        <div class="sentence-controls" id="sentenceControls">
            <button id="backSentenceButton">‚è™ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è</button>
            <button id="BackWordButton">‚è™ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Å–ª–æ–≤–æ</button>
            <button id="showTranslation">üîç –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥</button>
            <button id="pauseBtnLabel" onclick="togglePause()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
        </div>

        <div class="result-buttons" id="mainMenuButton">
            <button onclick="goToMainMenu()">üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>
        </div> 
        <div class="result-buttons" id="restartButton">
            <button onclick="restartLearning()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        </div> 

        <h3>–ü–æ–∑–Ω–∞—á—Ç–µ —Å–ª–æ–≤–æ —è–∫–µ –≤–∂–µ –≤–∏–≤—á–∏–ª–∏</h3>
        <div class="words-container" id="wordsContainer"></div>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        let isPaused = false;
        let currentIndex = 0; // –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –ø–æ —Ä–µ—á–µ–Ω–Ω—è—Ö
        let timer;
        let isPlaying = false;
        let isContinuingPlayback = false;
        let stopCurrentTranslation = false;

        const words = {{ words|safe }};
        let sentences = {{ sentences|safe }};
        let index = 0;
        const audioPlayer = document.getElementById('audioPlayer');

        // –§—É–Ω–∫—Ü—ñ—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–∞—É–∑–∏
        async function waitWhilePaused(timer = 200) {
            while (isPaused) {
                await sleep(timer);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø–∞—É–∑–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞–¥—É
        async function pauseForTranslation(duration = 5000, checkInterval = 200) {
            let elapsed = 0;
            while (elapsed < duration) {
                if (stopCurrentTranslation) {
                    stopCurrentTranslation = false; // –°–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å
                    break; // –Ø–∫—â–æ –ø–∞—É–∑–∞ –∑–Ω—è—Ç–∞ ‚Äî –≤–∏—Ö–æ–¥–∏–º–æ
                }
                await sleep(checkInterval);
                elapsed += checkInterval;
            }
        }

        // –ü–µ—Ä–µ–º–∏–∫–∞—á –ø–∞—É–∑–∏
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById("pauseBtnLabel").textContent = isPaused ? '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
            
            if (isPaused) {
                // –Ø–∫—â–æ –Ω–∞ –ø–∞—É–∑—ñ, –∑—É–ø–∏–Ω—è—î–º–æ –ø–æ—Ç–æ—á–Ω–µ –∞—É–¥—ñ–æ
                stopCurrentAudio();
            } else {
                // –Ø–∫—â–æ –≤–∏—Ö–æ–¥–∏–º–æ –∑ –ø–∞—É–∑–∏ ‚Äî –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –∞—É–¥—ñ–æ
                if (audioPlayer.src && audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.warn("Resume play error:", e));
                }
            }
        }
                
        // –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Å–ª–æ–≤–æ–º
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
                
        // –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ
        async function playAudio(src, speed = 1.0) {
            return new Promise((resolve) => {
                // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –Ω–æ–≤–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                setTimeout(() => {
                    audioPlayer.src = src;
                    audioPlayer.playbackRate = speed;
                    
                    isPlaying = true;
                    
                    audioPlayer.play().then(() => {
                        audioPlayer.onended = () => {
                            isPlaying = false;
                            resolve();
                        };
                    }).catch((err) => {
                        console.warn("Audio play error:", err);
                        isPlaying = false;
                        resolve(); // –Ω–µ –∑–∞–≤–∏—Å–∞—î–º–æ
                    });
                }, 100);
            });
        }        

        // –ó—É–ø–∏–Ω–∫–∞ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞—É–¥—ñ–æ
        function stopCurrentAudio() {
            audioPlayer.pause();
        }

        // –ó–∞–≥–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞ (—Å–ª–æ–≤–æ –∞–±–æ —Ä–µ—á–µ–Ω–Ω—è)
        async function playItem(item, isWord = true) {
            const settings = getDelaySettings();
            const hideTranslation = document.getElementById('hideTranslation').checked;
            const enableAudio = isWord 
                ? document.getElementById('enableWordAudio').checked 
                : document.getElementById('enableSentenceAudio').checked;
            const playTranslationFirst = document.getElementById('playTranslationFirst').checked;
            
            await waitWhilePaused();
            
            // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–ª—è—Ö—ñ–≤ –¥–æ –∞—É–¥—ñ–æ
            const enAudioPath = isWord 
                ? `/media/audio/en/${item.id}.mp3` 
                : `/${item.path_to_en}`;
            const ruAudioPath = isWord 
                ? `/media/audio/ru/${item.id}.mp3` 
                : `/${item.path_to_ru}`;
            
            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
            const originalText = isWord ? item.en : item.template;
            const translationText = isWord ? item.ru : item.translate;
            
            // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ª—ñ–≤
            document.getElementById('translationBox').textContent = "";
            
            if (playTranslationFirst && !hideTranslation) {
                // –°–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∑—É—î–º–æ —ñ –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –ø–µ—Ä–µ–∫–ª–∞–¥
                document.getElementById('wordBox').textContent = translationText;
                
                if (enableAudio) {
                    await playAudio(ruAudioPath);
                }
                
                await pauseForTranslation(settings.delayBeforeTranslation, 50);
                await waitWhilePaused();
                
                // –ü–æ—Ç—ñ–º –ø–æ–∫–∞–∑—É—î–º–æ —ñ –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª
                document.getElementById('wordBox').textContent = originalText;
                
                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableAudio) {
                        await playAudio(enAudioPath, settings.playbackSpeed);
                    }
                    
                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }
            } else {
                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫: —Å–ø–æ—á–∞—Ç–∫—É –æ—Ä–∏–≥—ñ–Ω–∞–ª, –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–∫–ª–∞–¥
                document.getElementById('wordBox').textContent = originalText;
                
                for (let i = 0; i < settings.repetitions; i++) {
                    if (enableAudio) {
                        await playAudio(enAudioPath, settings.playbackSpeed);
                    }
                    
                    await pauseForTranslation(settings.pauseBetween, 50);
                    await waitWhilePaused();
                }
                
                await waitWhilePaused();
                await pauseForTranslation(settings.delayBeforeTranslation, 50);
                
                if (!hideTranslation) {
                    document.getElementById('translationBox').textContent = translationText;
                    if (enableAudio) {
                        await playAudio(ruAudioPath);
                    }
                }
            }
            
            await waitWhilePaused();
            
            // –î–æ–¥–∞—î–º–æ —Å–ª–æ–≤–æ –¥–æ —Å–ø–∏—Å–∫—É –≤–∏–≤—á–µ–Ω–∏—Ö (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å–ª—ñ–≤)
            if (isWord) {
                const wordElement = document.createElement('div');
                const wordText = document.createElement('span');
                const checkbox = document.createElement('input');
                
                wordElement.classList.add('word-item');
                wordText.classList.add('word-text');
                checkbox.classList.add('word-checkbox');
                
                wordText.textContent = `${item.en} - ${item.ru}`;
                checkbox.type = 'checkbox';
                checkbox.addEventListener('change', () => {
                    wordElement.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
                });
                
                wordElement.appendChild(checkbox);
                wordElement.appendChild(wordText);
                document.getElementById('wordsContainer').appendChild(wordElement);
            }
        }

        // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ª–æ–≤–∞
        async function playCurrentWord() {
            if (index < 0) index = 0;
            if (index >= words.length) index = words.length - 1;
            
            const word = words[index];
            await playItem(word, true);
        }

        // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ—á–µ–Ω–Ω—è
        async function playCurrentSentence() {
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= sentences.length) currentIndex = sentences.length - 1;
            
            const sentence = sentences[currentIndex];
            await playItem(sentence, false);
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Å–ª–æ–≤–∞
        document.getElementById('BackWordButton').addEventListener('click', async () => {
            // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–∏–π –∑–≤—É–∫
            stopCurrentAudio();
            stopCurrentTranslation = true;
            
            // –Ø–∫—â–æ —î –∑–∞–ø—É—â–µ–Ω–∏–π —Ü–∏–∫–ª –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è, –ø–æ—Ç—Ä—ñ–±–Ω–æ –π–æ–≥–æ –ø–µ—Ä–µ—Ä–≤–∞—Ç–∏
            if (isContinuingPlayback) {
                isContinuingPlayback = false;
                // –î–∞—î–º–æ —á–∞—Å –∑—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ –ø–æ—Ç–æ—á–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
                await sleep(200);
            }
            
            if (index < 0) index = 0;
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–æ–≤–∏–π —Ü–∏–∫–ª –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–¥–Ω–æ–≥–æ —Å–ª–æ–≤–∞
            playingWords();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Ä–µ—á–µ–Ω–Ω—è
        document.getElementById('backSentenceButton').addEventListener('click', async () => {
            // –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–∏–π –∑–≤—É–∫
            stopCurrentAudio();
            stopCurrentTranslation = true;
            
            // –Ø–∫—â–æ —î –∑–∞–ø—É—â–µ–Ω–∏–π —Ü–∏–∫–ª –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è, –ø–æ—Ç—Ä—ñ–±–Ω–æ –π–æ–≥–æ –ø–µ—Ä–µ—Ä–≤–∞—Ç–∏
            if (isContinuingPlayback) {
                isContinuingPlayback = false;
                // –î–∞—î–º–æ —á–∞—Å –∑—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ –ø–æ—Ç–æ—á–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
                await sleep(200);
            }
            
            if (currentIndex < 0) currentIndex = 0;
            
            // –ü–æ—Ç—ñ–º –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
            PlayingSentences();
        });

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ—á–µ–Ω—å
        async function PlayingSentences() {
            if (isContinuingPlayback) return;
            
            isContinuingPlayback = true;
            
            while (isContinuingPlayback && currentIndex < sentences.length) {
                await waitWhilePaused();
                stopCurrentTranslation = false;
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                await playCurrentSentence();
                
                // –ó–±—ñ–ª—å—à—É—î–º–æ —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                currentIndex++;
                
                // –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –±—É–≤ –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ü–∏–∫–ª—É
                if (!isContinuingPlayback) break;
            }
            
            if (isContinuingPlayback) {
                // –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ –¥–æ –∫—ñ–Ω—Ü—è –ø—Ä–∏—Ä–æ–¥–Ω–∏–º —à–ª—è—Ö–æ–º
                document.getElementById('wordBox').textContent = "–ì–æ—Ç–æ–≤–æ! üéâ";
                document.getElementById('translationBox').textContent = "";
                document.getElementById('restartButton').style.display = 'flex';
                document.getElementById('mainMenuButton').style.display = 'flex';
            }
            
            isContinuingPlayback = false;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ª—ñ–≤
        async function playingWords() {
            if (isContinuingPlayback) return;
            
            isContinuingPlayback = true;
            
            while (isContinuingPlayback && index < words.length) {
                await waitWhilePaused();
                stopCurrentTranslation = false;
                
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                await playCurrentWord();
                
                // –ó–±—ñ–ª—å—à—É—î–º–æ —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –ø–æ–≤–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                index++;
                
                // –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –±—É–≤ –ø–µ—Ä–µ—Ä–≤–∞–Ω–∏–π, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ü–∏–∫–ª—É
                if (!isContinuingPlayback) break;
            }
            
            isContinuingPlayback = false;
            
            {% comment %} if (index == words.length) {
                PlayingSentences();
            } {% endcomment %}
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
        async function saveUserSettings() {
            const settings = getDelaySettings();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'save_user_settings' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ user_settings: settings }),
            })
            .then(res => res.json())  // –¥–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó
            .then(data => {
                console.log('Settings saved:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }        
            
        // –ü–æ—á–∞—Ç–æ–∫ –Ω–∞–≤—á–∞–Ω–Ω—è
        async function startLearning() {
            const enableSentenceAudio = document.getElementById('enableSentenceAudio').checked;
            const enableWordAudio = document.getElementById('enableWordAudio').checked;
            const settings = getDelaySettings();
            
            console.log('lessonRepeatCount:', settings.lessonRepeatCount);
            
            currentIndex = 0;
            index = 0;

            saveSettingsToSession();
            saveUserSettings();

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('settingsBlock').style.display = 'none';
            document.getElementById('sentenceControls').style.display = 'flex';
            document.getElementById('pauseBtnLabel').style.display = 'inline-flex';
            document.getElementById('showTranslation').style.display = 'inline-flex';

            // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–∞—Å–∏–≤—É —Ä–µ—á–µ–Ω—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
            adjustSentencesArray();

            for (let i = 0; i < settings.lessonRepeatCount; i++) {
                console.log(`=== –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ‚Ññ${i + 1} ===`);
                currentIndex = 0;
                index = 0;

                if (enableWordAudio) {
                    document.getElementById("backSentenceButton").style.display = 'none';
                    document.getElementById('BackWordButton').style.display = 'inline-flex';

                    await playingWords(); // –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Å–ª—ñ–≤
                }

                if (enableSentenceAudio) {
                    document.getElementById("BackWordButton").style.display = 'none';
                    document.getElementById("backSentenceButton").style.display = 'inline-flex';

                    await PlayingSentences(); // –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–µ—á–µ–Ω—å
                }
            }

            // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ª–∏—à–µ –ø—ñ—Å–ª—è –≤—Å—ñ—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω—å
            console.log('=== –ó–∞–≤–µ—Ä—à–µ–Ω–æ –≤—Å—ñ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ===');
            document.getElementById('wordBox').textContent = "–ì–æ—Ç–æ–≤–æ! üéâ";
            document.getElementById('translationBox').textContent = "";
            document.getElementById('restartButton').style.display = 'flex';
            document.getElementById('mainMenuButton').style.display = 'flex';
        }


        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑ –ø–æ–ª—ñ–≤ –≤–≤–µ–¥–µ–Ω–Ω—è
        function getDelaySettings() {
            return {
                lessonRepeatCount: parseInt(document.getElementById('lessonRepeatCount').value) || 1,
                repetitions: parseInt(document.getElementById('repeatCount').value) || 1,
                pauseBetween: parseInt(document.getElementById('pauseBetween').value) * 1000 || 1000,
                delayBeforeTranslation: parseFloat(document.getElementById('delayBeforeTranslation').value) * 1000 || 1000,
                playbackSpeed: parseFloat(document.getElementById('playbackSpeed').value) || 1.0,
                hideTranslation: document.getElementById('hideTranslation').checked,
                enableWordAudio: document.getElementById('enableWordAudio').checked,
                enableSentenceAudio: document.getElementById('enableSentenceAudio').checked,
                playTranslationFirst: document.getElementById('playTranslationFirst').checked,
                sentenceValue: parseInt(document.getElementById('sentenceValue').value) || 15
            };
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —É —Å—Ö–æ–≤–∏—â—ñ —Å–µ—Å—ñ—ó
        function saveSettingsToSession() {
            const settings = getDelaySettings();
            sessionStorage.setItem('wordLearningSettings', JSON.stringify(settings));
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∑—ñ —Å—Ö–æ–≤–∏—â–∞ —Å–µ—Å—ñ–π
        function loadSettingsFromSession() {
            const settingsJSON = sessionStorage.getItem('wordLearningSettings');
            if (settingsJSON) {
                const settings = JSON.parse(settingsJSON);
                document.getElementById('lessonRepeatCount').value = settings.lessonRepeatCount || 1;
                document.getElementById('repeatCount').value = settings.repetitions || 1;
                document.getElementById('pauseBetween').value = settings.pauseBetween / 1000 || 1;
                document.getElementById('delayBeforeTranslation').value = settings.delayBeforeTranslation / 1000 || 1;
                document.getElementById('playbackSpeed').value = settings.playbackSpeed || 1.0;
                document.getElementById('hideTranslation').checked = settings.hideTranslation || false;
                document.getElementById('enableWordAudio').checked = settings.enableWordAudio || false;
                document.getElementById('enableSentenceAudio').checked = settings.enableSentenceAudio || true;
                document.getElementById('playTranslationFirst').checked = settings.playTranslationFirst || false;
                document.getElementById('sentenceValue').value = settings.sentenceValue || 15;
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
        function goToMainMenu() {
            // –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤
            stopCurrentAudio();
            stopCurrentTranslation = true;
            isContinuingPlayback = false;
            
            window.location.href = '/'
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –Ω–∞–≤—á–∞–Ω–Ω—è
        function restartLearning() {
            window.location.reload();
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä–µ–∫–ª–∞–¥"
        document.getElementById('showTranslation').addEventListener('click', async () => {
            const word = words[index];
            const sentence = sentences[currentIndex];
            
            // –Ø–∫—â–æ –∑–∞—Ä–∞–∑ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ª–æ–≤–æ
            if (word && document.getElementById('wordBox').textContent === word.en) {
                document.getElementById('translationBox').textContent = word.ru;
                const enableWordAudio = document.getElementById('enableWordAudio').checked;
                if (enableWordAudio) {
                    await playAudio(`/media/audio/ru/${word.id}.mp3`);
                }
            } 
            // –Ø–∫—â–æ –∑–∞—Ä–∞–∑ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ä–µ—á–µ–Ω–Ω—è
            else if (sentence && document.getElementById('wordBox').textContent === sentence.template) {
                document.getElementById('translationBox').textContent = sentence.translate;
                const enableSentenceAudio = document.getElementById('enableSentenceAudio').checked;
                if (enableSentenceAudio) {
                    await playAudio(`/${sentence.path_to_ru}`);
                }
            }
        });

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–∞—Å–∏–≤—É —Ä–µ—á–µ–Ω—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
        function adjustSentencesArray() {
            const sentenceValue = parseInt(document.getElementById('sentenceValue').value) || 15;
            // –û–±–º–µ–∂—É—î–º–æ –º–∞—Å–∏–≤ —Ä–µ—á–µ–Ω—å –≤–∫–∞–∑–∞–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é, –∞–ª–µ –Ω–µ –ø–µ—Ä–µ–≤–∏—â—É—î–º–æ –Ω–∞—è–≤–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å
            if (sentenceValue < sentences.length) {
                sentences = sentences.slice(0, sentenceValue);
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', () => {
            loadSettingsFromSession();
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É
            document.getElementById('sentenceControls').style.display = 'none';
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ—á–∞—Ç–∫—É –Ω–∞–≤—á–∞–Ω–Ω—è
        document.getElementById('startBtn').addEventListener('click', () => {
            startLearning();
        });
    </script>
</body>
</html>
